# /phase:finalize - Cleanup and PR Creation

**Purpose**: Update documentation, delete project, create PR
**Mode**: Orchestrator in autonomous mode (with approval for documentation changes)

---

## Role

You are the finisher. **Update documentation, perform final checks, delete project folder, create PR.**

**Critical**: Project folder MUST be deleted before completing this phase.

---

## Workflow

### 1. Update Phase Status

Update `.sow/project/state.yaml`:
```yaml
phases:
  finalize:
    status: in_progress
    started_at: [timestamp]
```

Commit state change.

### 2. Documentation Subphase

**Determine documentation updates needed**:

**Review what was implemented**:
- Read task descriptions and logs
- Check file changes (git diff)
- Identify user-facing changes

**Review existing documentation**:
- README.md (root and subdirectories)
- CHANGELOG.md
- Developer guides
- API documentation
- Architecture docs

**Identify updates needed**:
- What's now outdated?
- What new features need documenting?
- What changed behavior needs updating?

**Consider design artifacts**:
- Should any ADRs move to repository? (e.g., `docs/adrs/`)
- Should design docs move to repository? (e.g., `docs/architecture/`)
- Implementation-specific notes stay in project (will be deleted)

**Present to human**:
```
Documentation updates needed:

Updates:
- README.md: [what needs updating]
- CHANGELOG.md: Add entry for [version]
- [other docs]: [updates]

Move artifacts:
- phases/design/adrs/001-decision.md â†’ docs/adrs/00X-decision.md

Approve these changes? [yes/adjust/skip]
```

**If skip**: Proceed without documentation updates (unusual but allowed)

**If approved**: Make changes, commit

**Update state**:
```yaml
phases:
  finalize:
    documentation_updates:
      - README.md
      - CHANGELOG.md
    artifacts_moved:
      - from: phases/design/adrs/001-decision.md
        to: docs/adrs/003-decision.md
```

### 3. Final Checks

**Run tests**:
```bash
[test command based on project type]
```

**If tests fail**: "Tests failing. Must loop back to implementation to fix."

**Run linters** (if configured):
```bash
[lint command based on project type]
```

**If linter fails**: Fix automatically if trivial, otherwise loop back to implementation

**Verify git tree clean**:
```bash
git status
```

**If uncommitted changes**: Commit them with appropriate message

### 4. Critical: Delete Project Folder

**This step is mandatory and cannot be skipped.**

**Verify all work committed**:
- All implementation changes committed
- All documentation updates committed
- Git tree clean

**Delete project**:
```bash
rm -rf .sow/project/
```

**Create cleanup commit**:
```bash
git add .sow/
git commit -m "chore: remove sow project files before merge

Project '[project-name]' complete and ready for merge.
Project state deleted per sow protocol.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**Push to remote**:
```bash
git push origin [branch-name]
```

**Update state** (before deletion):
```yaml
phases:
  finalize:
    project_deleted: true
```

**Note**: This is the last state update since project folder will be deleted immediately after.

### 5. Create Pull Request

**Check for gh CLI**:
```bash
which gh
```

**If gh available**: Create PR automatically

**PR title**: Descriptive summary of changes
- Examples: "Add JWT authentication", "Fix login bug after password reset", "Refactor auth module"

**PR description**: Use comprehensive template

```markdown
## Summary

[1-3 sentence summary of changes]

## Changes Made

- [Key change 1]
- [Key change 2]
- [Key change 3]

## Implementation Details

[Brief technical summary from implementation/design phases]

## Testing

- [Test approach]
- [Coverage details]

## Documentation

- [What docs were updated]

## Related

- Closes #[issue] (if applicable)

---

ðŸ¤– Generated by sow project: [project-name]

Review reports: [Note: deleted with project folder]
```

**Create PR**:
```bash
gh pr create --title "[title]" --body "[description]"
```

**Capture PR URL**, update state

**If gh NOT available**: Instruct human

```
The gh CLI is not available. Please create PR manually:

1. Go to GitHub repository
2. Click 'New Pull Request'
3. Select branch: [branch-name]
4. Use this title: [suggested title]
5. Use this description:

[Generated PR description]

I'll wait for you to create the PR.
```

### 6. Complete Phase

**Output**:
```
âœ“ Finalize phase complete!

Documentation updated:
- [list of updated files]

Artifacts moved:
- [list of moved artifacts]

Project folder deleted (cleanup commit pushed)

PR created: [URL or "Created manually by human"]

Next steps:
1. Review the PR
2. Address any PR feedback
3. Merge when approved
4. Delete feature branch after merge

Note: Project state has been removed. This project cannot be resumed.
```

**This is the end** - no further phase transitions.

---

## Key Behaviors

**Autonomous with documentation gate**:
- Most work happens automatically
- Only approval needed for documentation changes
- Final checks run automatically

**Project deletion is mandatory**:
- Cannot complete finalize without deleting project
- This is enforced by protocol
- Ensures clean main branch

**PR creation**:
- Prefer gh CLI (automatic)
- Fall back to manual instructions
- Comprehensive description with context

**No going back**:
- Once project deleted, cannot resume
- This is intentional - work is complete
- Next work requires new project

---

## Edge Cases

**Tests fail**: "Tests failing: [details]. Must loop back to implementation. Approve?" â†’ If approved, return to implementation phase

**Linter fails with non-trivial issues**: Same as test failure

**gh CLI auth issues**: "gh CLI not authenticated. Options: 1) Authenticate now, 2) Create PR manually"

**No documentation updates needed**: Valid - present empty list, proceed with approval

**Merge conflicts on push**: "Push failed due to conflicts. Options: 1) Pull and resolve, 2) I'll handle it manually"

**Branch doesn't exist on remote**: "Branch not on remote. Creating..." â†’ `git push -u origin [branch]`

---

## Example Flow

```
[/phase:finalize invoked]

Analyzing changes for documentation updates...

[Reviews implementation: added JWT auth endpoints]
[Checks existing docs: README has auth section, CHANGELOG exists]

Documentation updates needed:

Updates:
- README.md: Add JWT authentication section
- CHANGELOG.md: Add v1.2.0 entry
- docs/api-reference.md: Document new auth endpoints

Move artifacts:
- phases/design/adrs/001-use-jwt.md â†’ docs/adrs/003-use-jwt.md

Approve? [yes]

[Updates README.md]
[Updates CHANGELOG.md]
[Updates docs/api-reference.md]
[Moves ADR to docs/adrs/]
[Commits documentation changes]

Running final checks...

âœ“ Tests passing (42 tests, 0 failures)
âœ“ Linters passing
âœ“ Git tree clean

Deleting project folder...

[rm -rf .sow/project/]
[Creates cleanup commit]
[Pushes to remote]

âœ“ Project folder deleted

Creating pull request...

[Checks gh CLI available]
[Creates PR with generated title and description]

PR created: https://github.com/org/repo/pull/123

âœ“ Finalize phase complete!

Documentation updated:
- README.md (added auth section)
- CHANGELOG.md (v1.2.0 entry)
- docs/api-reference.md (auth endpoints)

Artifacts moved:
- ADR 001 â†’ docs/adrs/003-use-jwt.md

Project folder deleted (cleanup commit pushed)

PR created: https://github.com/org/repo/pull/123

Next steps:
1. Review the PR
2. Address any PR feedback
3. Merge when approved
4. Delete feature branch after merge

Note: Project state has been removed. This project cannot be resumed.
```

---

## Notes

- **Project deletion mandatory**: Cannot skip this step
- **Documentation approval needed**: Only gate in this phase
- **Automatic final checks**: Tests, linters, git status
- **PR creation preferred**: gh CLI automatic, manual fallback
- **End of lifecycle**: No further phases, project complete
- **Human merges PR**: Orchestrator never merges (human responsibility)
