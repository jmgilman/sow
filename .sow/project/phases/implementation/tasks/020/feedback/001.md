# Task 020 Review: Intra-Phase State Progression Command

## Summary of Requirements

Task 020 required:
1. Add `Advance()` method to Phase interface with signature `(*PhaseOperationResult, error)`
2. Implement `sow agent advance` CLI command
3. Update all existing standard phases to implement Advance() returning `ErrNotSupported`
4. Write comprehensive tests for the command and phase implementations
5. Handle errors appropriately (especially `ErrNotSupported`)

## Changes Implemented

### Phase Interface Extension (cli/internal/project/domain/interfaces.go)

✓ **Added Advance() method** to Phase interface:
```go
// Advance to next state within this phase
// Returns ErrNotSupported if phase has no internal states
Advance() (*PhaseOperationResult, error)
```

Proper signature matching requirements, with clear documentation.

### CLI Command Implementation (cli/cmd/agent/advance.go)

✓ **New command created** with:
- Proper error handling for `ErrNotSupported`
- Event firing when `PhaseOperationResult.Event` is non-empty
- State persistence after successful advance
- Clear help text explaining the command's purpose
- Good error messages for various failure scenarios

The implementation follows existing patterns from `complete.go` and is well-structured.

### Command Registration (cli/cmd/agent/agent.go)

✓ **Command properly registered**:
- Added to command list with `cmd.AddCommand(NewAdvanceCmd())`
- Help text updated to document the advance command

### Standard Phase Implementations

✓ **All 4 standard phases updated**:
- `planning.go:150` - Advance() returns `(nil, project.ErrNotSupported)`
- `implementation.go:148` - Advance() returns `(nil, project.ErrNotSupported)`
- `review.go:171` - Advance() returns `(nil, project.ErrNotSupported)`
- `finalize.go:131` - Advance() returns `(nil, project.ErrNotSupported)`

All implementations are consistent and correct.

### Testing

**Tests created**:
- `cli/cmd/agent/advance_test.go` - Command-level tests
- `cli/internal/project/standard/advance_test.go` - Phase Advance() tests
- `cli/internal/project/standard/phases_test.go` - Updated with Advance test cases

## Issues Found

### ❌ Test Compilation Failures

Running `go test ./internal/project/standard` reveals **compilation errors** in existing test files:

**Files affected**:
- `internal/project/standard/phases_test.go` - Multiple bool → *bool errors
- `internal/project/standard/prompts_test.go` - Multiple bool → *bool errors

**Root cause**: These are leftover from Task 010's breaking change (making `Artifact.Approved` optional). These test files were not in Task 010's files_modified list, indicating they were missed during that task.

**Example errors**:
```
phases_test.go:226:17: cannot use true (untyped bool constant) as *bool value in struct literal
prompts_test.go:133:15: cannot use false (untyped bool constant) as *bool value in struct literal
```

**Required fixes**: All references to `Approved: true/false` must be changed to use bool pointers:
- `Approved: true` → `Approved: boolPtr(true)`
- `Approved: false` → `Approved: boolPtr(false)`

Or using inline helpers like `&[]bool{true}[0]` if no helper exists.

## Assessment

**REQUEST CHANGES** ⚠️

While the core implementation of Task 020 is **excellent and complete**, the codebase cannot compile due to test failures inherited from Task 010's incomplete breaking change fixes.

**What was done well**:
1. ✓ Phase interface correctly extended
2. ✓ Command implementation follows best practices
3. ✓ All 4 phases properly updated
4. ✓ Command registration correct
5. ✓ Error handling comprehensive
6. ✓ Good documentation and comments

**What needs fixing**:
1. ❌ Fix test compilation errors in `phases_test.go` (11+ instances)
2. ❌ Fix test compilation errors in `prompts_test.go` (10+ instances)

These fixes should use the same pattern established in Task 010:
```go
// Old
Approved: true

// New
Approved: &[]bool{true}[0]
// OR
Approved: boolPtr(true)  // if helper exists
```

## Recommendation

**Request changes** to fix the test compilation errors. Once those are addressed and tests pass, approve the task.

The implementer should:
1. Add a `boolPtr` helper if it doesn't exist
2. Update all test files to use pointer syntax for `Artifact.Approved`
3. Verify `go test ./...` passes
4. Mark as needs_review again

---

**Reviewed by**: Orchestrator Agent
**Date**: 2025-10-31
**Status**: Changes Requested
