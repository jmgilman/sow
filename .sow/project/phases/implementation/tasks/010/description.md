# Create CUE Schema for .sow-ref.yaml Manifest

## Context

This task is part of Work Unit 002, which creates the schema and validation infrastructure for `.sow-ref.yaml` manifest files. These manifests are required in all OCI-distributed refs and define metadata including title, link name, content description, classifications, tags, and optional provenance/packaging/hints sections.

The sow codebase uses CUE schemas for all structured data validation. CUE schemas are:
- Stored in `libs/schemas/` (embedded via `//go:embed`)
- Used to generate Go types via `cue exp gengotypes`
- Loaded at runtime for validation using the CUE Go library

This task creates the schema file and generates the corresponding Go types. The subsequent task will implement the validation function and tests.

## Requirements

### CUE Schema File

Create `libs/schemas/ref_manifest.cue` with the following schema definitions:

**Package declaration:**
```cue
package schemas
```

**Main schema definition - `#RefManifest`:**

The root schema for `.sow-ref.yaml` files with these fields:

1. `schema_version` (required): Semver format string
   - Pattern: `^[0-9]+\.[0-9]+\.[0-9]+$`
   - Example values: "1.0.0", "0.1.0"

2. `ref` (required): Core identification using `#RefIdentification` type

3. `content` (required): Content description using `#RefContent` type

4. `provenance` (optional): Authorship info using `#RefProvenance` type

5. `packaging` (optional): Publishing config using `#RefPackaging` type

6. `hints` (optional): LLM usage hints using `#RefHints` type

7. `metadata` (optional): Freeform map for organization-specific data
   - Use `{...}` to allow any structure

**Supporting type definitions:**

`#RefIdentification`:
- `title`: Human-readable name (non-empty string)
- `link`: Symlink name in kebab-case format
  - Pattern: `^[a-z0-9][a-z0-9-]*[a-z0-9]$`
  - Must start and end with alphanumeric
  - Can contain hyphens in the middle
  - Examples: "go-standards", "api-patterns", "my-ref"

`#RefContent`:
- `description`: Non-empty string (required)
- `summary`: Optional longer description string
- `classifications`: Array of at least one `#RefClassification`
  - Use CUE list constraint: `[#RefClassification, ...#RefClassification]`
- `tags`: Array of at least one string
  - Use CUE list constraint: `[string, ...string]`

`#RefClassification`:
- `type`: One of the predefined `#ClassificationType` enum values
- `description`: Optional string describing the classification

`#ClassificationType` (enum):
Define as a disjunction of string literals:
```cue
#ClassificationType: "tutorial" | "api-reference" | "guidelines" |
    "architecture" | "runbook" | "specification" | "reference" |
    "code-examples" | "code-templates" | "code-library" | "uncategorized"
```

`#RefProvenance`:
- `authors`: Optional array of strings
- `created`: Optional string (RFC 3339 timestamp)
- `updated`: Optional string (RFC 3339 timestamp)
- `source`: Optional string (e.g., git URL)
- `license`: Optional string (e.g., "MIT", "Apache-2.0")

Note: Use `string` for timestamps rather than `time.Time` to avoid CUE import complexity. Timestamp format validation will be handled at the Go level if needed.

`#RefPackaging`:
- `exclude`: Optional array of strings (glob patterns)

`#RefHints`:
- `suggested_queries`: Optional array of strings
- `primary_files`: Optional array of strings

### Code Generation

After creating the schema, verify Go types are generated by running:
```bash
go generate ./libs/schemas/...
```

This should update `libs/schemas/cue_types_gen.go` with new types:
- `RefManifest`
- `RefIdentification`
- `RefContent`
- `RefClassification`
- `RefProvenance`
- `RefPackaging`
- `RefHints`

Note: `#ClassificationType` is a string literal union, so it will be represented as `string` in Go, not a separate type.

## Acceptance Criteria

1. `libs/schemas/ref_manifest.cue` exists and follows existing schema conventions
2. The schema compiles without errors:
   ```bash
   cd libs/schemas && cue eval ref_manifest.cue
   ```
3. Running `go generate ./libs/schemas/...` succeeds
4. New types appear in `libs/schemas/cue_types_gen.go`
5. The schema follows the same patterns as existing schemas (e.g., `refs_committed.cue`, `refs_cache.cue`):
   - Uses `#` prefix for type definitions
   - Uses regex constraints where appropriate
   - Uses `?` for optional fields
   - Uses list constraints for non-empty arrays

**Test Requirements (TDD approach):**
- Write schema compilation tests before implementation
- Test that the schema can be loaded from embedded FS
- Verify schema definitions can be looked up by name

## Technical Details

### Existing Schema Patterns to Follow

From `refs_committed.cue`:
```cue
// Regex validation
id: string & =~"^[a-z0-9-]+$"

// Non-empty string
source: string & !=""

// Enum type
semantic: "knowledge" | "code"

// Optional field
branch?: string & !=""

// Array with spread
refs: [...#Ref]
```

From `refs_cache.cue`:
```cue
// Using time.Time (but we'll use string for simplicity)
import "time"
last_updated: time.Time

// Nested optional structs
metadata: #CacheMetadata
#CacheMetadata: {
    git?: #GitMetadata
    file?: #FileMetadata
}
```

### File Location and Embedding

- Place schema at: `libs/schemas/ref_manifest.cue`
- The existing `embed.go` already embeds `*.cue`, so no changes needed there
- The `cue.mod/module.cue` already exists with correct configuration

### Generated Type Expectations

The generated Go types should have json tags matching CUE field names (snake_case). Example expected output:

```go
type RefManifest struct {
    Schema_version string            `json:"schema_version"`
    Ref            RefIdentification `json:"ref"`
    Content        RefContent        `json:"content"`
    Provenance     *RefProvenance    `json:"provenance,omitempty"`
    Packaging      *RefPackaging     `json:"packaging,omitempty"`
    Hints          *RefHints         `json:"hints,omitempty"`
    Metadata       map[string]any    `json:"metadata,omitempty"`
}
```

## Relevant Inputs

- `libs/schemas/refs_committed.cue` - Pattern for ref-related schema with regex validation
- `libs/schemas/refs_cache.cue` - Pattern for optional fields and nested types
- `libs/schemas/project/project.cue` - Pattern for complex nested struct definitions
- `libs/schemas/embed.go` - Shows how schemas are embedded (no changes needed)
- `libs/schemas/cue_types_gen.go` - Current generated types (will be updated)
- `libs/schemas/cue.mod/module.cue` - CUE module configuration
- `.sow/project/context/issue-124.md` - Full issue requirements
- `.sow/knowledge/designs/oci-refs/oci-refs-design.md` (lines 369-436) - Schema specification

## Examples

### Valid Minimal Manifest

```yaml
schema_version: "1.0.0"
ref:
  title: "Go Team Standards"
  link: "go-standards"
content:
  description: "Team Go coding conventions and best practices."
  classifications:
    - type: guidelines
  tags:
    - golang
```

### Valid Full Manifest

```yaml
schema_version: "1.0.0"
ref:
  title: "Go Team Standards"
  link: "go-standards"
content:
  description: "Team Go coding conventions and best practices."
  summary: |
    Complete reference for Go development covering coding standards,
    testing practices, code review guidelines, and architecture patterns.
  classifications:
    - type: guidelines
      description: "Go coding standards for the team"
    - type: code-examples
  tags:
    - golang
    - conventions
    - testing
provenance:
  authors:
    - "Platform Team"
  created: "2024-01-15T10:00:00Z"
  updated: "2025-01-30T15:30:00Z"
  source: "https://github.com/myorg/team-docs"
  license: "MIT"
packaging:
  exclude:
    - "*.draft.md"
    - ".DS_Store"
    - "tmp/"
hints:
  suggested_queries:
    - "How should I structure error handling?"
  primary_files:
    - "README.md"
    - "standards/golang.md"
metadata:
  team: "platform"
  audience: "all-engineers"
```

### Invalid Examples (for reference)

```yaml
# Invalid: missing required fields
schema_version: "1.0.0"
ref:
  title: "Test"
  # missing link
content:
  description: "Test"
  # missing classifications and tags
```

```yaml
# Invalid: bad link format (uppercase)
ref:
  link: "Go-Standards"  # Should be lowercase

# Invalid: bad link format (starts with hyphen)
ref:
  link: "-go-standards"

# Invalid: unknown classification type
content:
  classifications:
    - type: "guidlines"  # Typo - not in enum
```

## Dependencies

- None - this is the first task in the work unit
- CUE tooling must be installed (verified by running `cue version`)

## Constraints

- Do not modify `embed.go` - it already embeds `*.cue`
- Do not modify `cue.mod/module.cue` unless absolutely necessary
- Follow existing naming conventions in the schemas package
- Schema must use `package schemas` (not a subpackage)
- Keep timestamp fields as `string` type for simplicity (format validation at Go level)
- The schema must pass `golangci-lint run ./libs/schemas/...`
