# Test: Review Failure Rework Cycle
# Purpose: Test that review failures properly increment iteration and transition back to implementation
# Coverage: phase status=failed, iteration auto-increment, review feedback as input

# =====================================
# Setup: Create project and advance to review
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/test-review-fail
exec sow init
exec git add .sow
exec git commit -m 'Initialize sow'
env SOW_SKIP_UNCOMMITTED_CHECK=1
exec sow project new --branch feat/test-review-fail --no-launch 'Test review failure cycle'

# Change into worktree
cd .sow/worktrees/feat/test-review-fail

# Verify initial state is ImplementationPlanning
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# =====================================
# Advance through implementation phases
# =====================================

# Add task descriptions and approve them
exec mkdir -p .sow/project/context/tasks
exec sh -c 'echo "# Task 010\nImplement feature X" > .sow/project/context/tasks/010-feature-x.md'
exec sow output add --type task_description --path context/tasks/010-feature-x.md --phase implementation
exec sow output set --index 0 approved true --phase implementation

# Transition to executing
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationExecuting'

# Add and complete a task
exec sow task add 'Implement feature X' --agent implementer --id 010
exec sow task set --id 010 status completed

# Verify implementation phase has no iteration yet (first time)
exec cat .sow/project/state.yaml
! stdout 'iteration:'

# Transition to review
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ReviewActive'

# =====================================
# First Review: FAIL
# =====================================

# Create review report with fail assessment
exec mkdir -p .sow/project/phases/review/reports
exec sh -c 'echo "# Review Report 001\n\nAssessment: FAIL\n\nIssues:\n- Missing tests\n- Poor error handling" > .sow/project/phases/review/reports/001.md'

# Register review output with fail assessment
exec sow output add --type review --path phases/review/reports/001.md --phase review --metadata.assessment fail
exec sow output set --index 0 approved true --phase review

# Verify review phase status before transition
exec cat .sow/project/state.yaml
stdout '(?s)review:.*status: in_progress'

# Advance (should trigger EventReviewFail)
exec sow advance

# =====================================
# Verify First Rework Transition
# =====================================

# Should be back in ImplementationPlanning
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# Verify review phase marked as failed
exec cat .sow/project/state.yaml
stdout '(?s)review:.*status: failed'

# Verify implementation iteration incremented to 1
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*iteration: 1'

# Verify implementation phase status is in_progress
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: in_progress'

# Verify failed review added as implementation input
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*inputs:.*type: review'
stdout '(?s)inputs:.*assessment: fail'

# =====================================
# Second Implementation Cycle
# =====================================

# Add new task description for rework
exec sh -c 'echo "# Task 020\nAdd missing tests and fix error handling" > .sow/project/context/tasks/020-add-tests.md'
exec sow output add --type task_description --path context/tasks/020-add-tests.md --phase implementation
exec sow output set --index 1 approved true --phase implementation

# Transition to executing
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationExecuting'

# Complete the rework task
exec sow task add 'Add missing tests' --agent implementer --id 020
exec sow task set --id 020 status completed

# Transition back to review
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ReviewActive'

# =====================================
# Second Review: FAIL AGAIN
# =====================================

# Create second review report with fail assessment
exec sh -c 'echo "# Review Report 002\n\nAssessment: FAIL\n\nIssues:\n- Tests still incomplete" > .sow/project/phases/review/reports/002.md'

# Register second review with fail assessment
exec sow output add --type review --path phases/review/reports/002.md --phase review --metadata.assessment fail
exec sow output set --index 1 approved true --phase review

# Reset review phase to failed status (simulating the transition)
exec sow phase set status in_progress --phase review

# Advance (second fail)
exec sow advance

# =====================================
# Verify Second Rework Transition
# =====================================

# Should be back in ImplementationPlanning again
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# Verify review phase marked as failed again
exec cat .sow/project/state.yaml
stdout '(?s)review:.*status: failed'

# Verify implementation iteration incremented to 2
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*iteration: 2'

# =====================================
# Third Implementation Cycle (Success Path)
# =====================================

# Add task description for final rework
exec sh -c 'echo "# Task 030\nComplete all remaining tests" > .sow/project/context/tasks/030-complete-tests.md'
exec sow output add --type task_description --path context/tasks/030-complete-tests.md --phase implementation
exec sow output set --index 2 approved true --phase implementation

# Transition to executing
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationExecuting'

# Complete the final task
exec sow task add 'Complete tests' --agent implementer --id 030
exec sow task set --id 030 status completed

# Transition to review
exec sow advance
exec cat .sow/project/state.yaml
stdout 'current_state: ReviewActive'

# =====================================
# Third Review: PASS
# =====================================

# Create review report with pass assessment
exec sh -c 'echo "# Review Report 003\n\nAssessment: PASS\n\nAll requirements met." > .sow/project/phases/review/reports/003.md'

# Register review with pass assessment
exec sow output add --type review --path phases/review/reports/003.md --phase review --metadata.assessment pass
exec sow output set --index 2 approved true --phase review

# Reset review phase status
exec sow phase set status in_progress --phase review

# Advance (should go to finalize, not back to implementation)
exec sow advance

# =====================================
# Verify Success Transition
# =====================================

# Should be in FinalizeChecks (not ImplementationPlanning)
exec cat .sow/project/state.yaml
stdout 'current_state: FinalizeChecks'

# Verify implementation iteration stayed at 2
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*iteration: 2'

# Verify review phase NOT marked as failed this time
# (it should be in_progress or completed, not failed)
exec cat .sow/project/state.yaml
! stdout '(?s)review:.*status: failed'

# =====================================
# Summary
# =====================================
# This test verifies:
# 1. Review fail marks review phase as "failed"
# 2. Iteration auto-increments on each rework (1, 2)
# 3. Failed review added as implementation input
# 4. Multiple fail cycles work correctly
# 5. Pass assessment transitions to finalize (not implementation)
