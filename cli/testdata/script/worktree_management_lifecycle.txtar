# Test worktree management lifecycle
# Validates: list and prune commands
# Note: Remove is tested in worktree_command_basic.txtar

# =====================================
# Setup
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'

exec sh -c 'echo ".sow/worktrees/" > .gitignore'
exec git add .gitignore
exec git commit -m 'init'

exec sow init
exec git add .sow
exec git commit -m 'sow init'

env SOW_SKIP_UNCOMMITTED_CHECK=1

# =====================================
# Test: Create and List
# =====================================

exec sow explore --branch explore/one --no-launch
exec sow worktree list
stdout 'explore/one'
stdout 'exploration'

# =====================================
# Test: Prune orphaned metadata
# =====================================

# Manually delete worktree directory (simulating manual deletion or corruption)
exec rm -rf .sow/worktrees/explore/one

# Prune cleans up orphaned metadata
exec sow worktree prune
stdout 'Pruned'

# Verify cleanup
exec git worktree list
! stdout 'explore/one'
