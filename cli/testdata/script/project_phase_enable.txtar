# Test project phase enable command
# Should enable optional phases (discovery and design)

exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/test-feature
exec sow init
exec sow project init my-feature --description 'Add new feature'

# Test enabling discovery phase with type
exec sow project phase enable discovery --type feature
stderr '✓ Enabled discovery phase'

# Verify discovery phase is enabled
exec sow project phase status
stderr '\[✓\] Discovery.*pending'

# Complete discovery to transition to design decision
exec sow project phase complete discovery

# Test enabling design phase
exec sow project phase enable design
stderr '✓ Enabled design phase'

# Verify design phase is enabled
exec sow project phase status
stderr '\[✓\] Design.*pending'

# Test enabling discovery again fails (wrong state)
! exec sow project phase enable discovery --type bug
stderr 'cannot enable discovery'

# Test enabling implementation phase fails (not manually enabled)
! exec sow project phase enable implementation
stderr 'only discovery and design'

# Test enabling review phase fails (not manually enabled)
! exec sow project phase enable review
stderr 'only discovery and design'

# Test enabling finalize phase fails (not manually enabled)
! exec sow project phase enable finalize
stderr 'only discovery and design'

# Test invalid phase name
! exec sow project phase enable invalid-phase
stderr 'invalid phase'

# Clean up and test discovery without type flag on new project
exec sow project delete --force
exec git checkout -b feat/test-no-type
exec sow project init test-no-type --description 'Test without type'
! exec sow project phase enable discovery
stderr 'discovery type required'

# Test all valid discovery types
exec sow project delete --force
exec git checkout -b feat/test-bug
exec sow project init bug-fix --description 'Fix a bug'
exec sow project phase enable discovery --type bug
stderr '✓ Enabled discovery phase'

exec sow project delete --force
exec git checkout -b feat/test-docs
exec sow project init docs-update --description 'Update docs'
exec sow project phase enable discovery --type docs
stderr '✓ Enabled discovery phase'

exec sow project delete --force
exec git checkout -b feat/test-refactor
exec sow project init refactor-code --description 'Refactor code'
exec sow project phase enable discovery --type refactor
stderr '✓ Enabled discovery phase'

exec sow project delete --force
exec git checkout -b feat/test-general
exec sow project init general-work --description 'General work'
exec sow project phase enable discovery --type general
stderr '✓ Enabled discovery phase'

# Test invalid discovery type
exec sow project delete --force
exec git checkout -b feat/test-invalid-type
exec sow project init invalid-type --description 'Test invalid type'
! exec sow project phase enable discovery --type invalid-type
stderr 'invalid discovery type'
