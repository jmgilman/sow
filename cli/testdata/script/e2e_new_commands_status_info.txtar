# Test: E2E New Commands - Status and Info Validation
# Purpose: Validate status and info commands show correct information throughout lifecycle
# Exercises: Detailed output validation for status and info commands

# =====================================
# Setup
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/status-info-test
exec sow init

# =====================================
# Project Initialization
# =====================================
exec sow agent init status-test --description 'Test status and info commands'

# =====================================
# Test status at planning active state
# =====================================
exec sow agent status
stderr 'Project: status-test'
stderr 'Branch: feat/status-info-test'
stderr 'Active Phase: planning'

# =====================================
# Test info shows planning phase
# =====================================
exec sow agent info
stderr 'Phase: planning'

# =====================================
# Add and approve task list to complete planning
# =====================================
exec mkdir -p .sow/project/artifacts
exec sh -c 'echo "# Task List" > .sow/project/artifacts/task-list.md'
exec sow agent artifact add project/artifacts/task-list.md --metadata type=task_list
exec sow agent artifact approve project/artifacts/task-list.md

exec sow agent complete

# Should have transitioned to implementation
exec sow agent status
stderr 'Active Phase: implementation'

# Add multiple tasks with different statuses
exec sow agent task add 'Task 1' --description 'First'
exec sow agent task add 'Task 2' --description 'Second'
exec sow agent task add 'Task 3' --description 'Third'

# Check status shows task breakdown
exec sow agent status
stderr 'Tasks: 3 total'
stderr '○ 3 pending'

# Update tasks to different statuses
exec sow agent task approve
exec sow agent task update 010 --status completed
exec sow agent task update 020 --status in_progress

exec sow agent status
stderr 'Tasks: 3 total'
stderr '✓ 1 completed'
stderr '⟳ 1 in progress'
stderr '○ 1 pending'

# Mark one as abandoned
exec sow agent task update 030 --status abandoned

exec sow agent status
stderr 'Tasks: 3 total'
stderr '✓ 1 completed'
stderr '⟳ 1 in progress'
stderr '✗ 1 abandoned'

# =====================================
# Complete implementation and check review info
# =====================================
exec sow agent task update 020 --status completed
# Auto-transitions to review when all non-abandoned tasks complete

exec sow agent status
stderr 'Active Phase: review'

exec sow agent info
stderr 'Phase: review'

# =====================================
# Complete to finalize
# =====================================
exec sow agent artifact add reports/001-review.md --metadata type=review --metadata assessment=pass
exec sow agent artifact approve reports/001-review.md

exec sow agent complete

exec sow agent status
stderr 'Active Phase: finalize'

exec sow agent info
stderr 'Phase: finalize'

# =====================================
# Cleanup
# =====================================
exec sow agent complete
exec sow agent delete --force
