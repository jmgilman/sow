# Test task-level logging
# Should create log entries in task-specific log.md

exec git init

-- .sow/.version --
1.0.0

-- .sow/refs/index.json --
{
  "version": "1.0.0",
  "refs": []
}

-- .sow/project/state.yaml --
project:
  name: test-project
  branch: main
  description: Test project
  created_at: 2025-10-16T10:00:00Z
  updated_at: 2025-10-16T10:00:00Z
phases:
  discovery:
    status: skipped
    enabled: false
    created_at: 2025-10-16T10:00:00Z
    started_at: null
    completed_at: null
    discovery_type: null
    artifacts: []
  design:
    status: skipped
    enabled: false
    created_at: 2025-10-16T10:00:00Z
    started_at: null
    completed_at: null
    architect_used: null
    artifacts: []
  implementation:
    status: in_progress
    enabled: true
    created_at: 2025-10-16T10:00:00Z
    started_at: 2025-10-16T10:00:00Z
    completed_at: null
    planner_used: null
    tasks: []
    pending_task_additions: null
  review:
    status: pending
    enabled: true
    created_at: 2025-10-16T10:00:00Z
    started_at: null
    completed_at: null
    iteration: 1
    reports: []
  finalize:
    status: pending
    enabled: true
    created_at: 2025-10-16T10:00:00Z
    started_at: null
    completed_at: null
    project_deleted: false
    pr_url: null

-- .sow/project/phases/implementation/tasks/010/state.yaml --
task:
  id: "010"
  name: "Test task"
  phase: implementation
  status: in_progress
  created_at: 2025-10-16T10:00:00Z
  started_at: 2025-10-16T10:00:00Z
  updated_at: 2025-10-16T10:00:00Z
  completed_at: null
  iteration: 2
  assigned_agent: implementer
  references: []
  feedback: []
  files_modified: []

# Navigate to task directory
cd .sow/project/phases/implementation/tasks/010

# Create a task log entry
exec sow log --action created_file --result success --file src/auth.go --notes "Created auth module"
stderr '✓ Log entry added to task log'

# Verify log file was created
exists log.md

# Verify log content includes correct agent ID with iteration
exec cat log.md
stdout 'timestamp:'
stdout 'agent: implementer-2'
stdout 'action: created_file'
stdout 'result: success'
stdout '  - src/auth.go'
stdout 'Created auth module'

# Add another entry
exec sow log --action test_run --result partial --notes "Tests partially passing"
stderr '✓ Log entry added to task log'

# Verify both entries exist
exec cat log.md
stdout 'test_run'
stdout 'result: partial'
stdout 'Tests partially passing'
