# Test: E2E Discovery Only
# Purpose: Discovery phase workflow with artifacts and approval
# Exercises: Enable discovery, add artifacts, approve, complete phase

# =====================================
# Setup
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/discovery-test
exec sow init
stderr '✓ sow initialized successfully'

# =====================================
# Project Initialization
# =====================================
exec sow project init discovery-project --description 'Test discovery phase'
stderr '✓ Initialized project ''discovery-project'''

# =====================================
# Enable Discovery Phase
# =====================================
exec sow project phase enable discovery --type feature
stderr '✓ Enabled discovery phase'

# Verify discovery phase directory created
exists .sow/project/phases/discovery

# Create artifact files first (they need to exist)
exec mkdir -p .sow/project/phases/discovery/research
exec sh -c 'echo "# Research Report 1\n\nJWT libraries analysis" > .sow/project/phases/discovery/research/001-jwt.md'
exec sh -c 'echo "# Research Report 2\n\nAuth patterns" > .sow/project/phases/discovery/research/002-auth.md'

# =====================================
# Add Artifacts
# =====================================
# Add first artifact
exec sow project artifact add phases/discovery/research/001-jwt.md --phase discovery
stderr '✓ Added artifact to discovery phase'

# Add second artifact (pre-approved)
exec sow project artifact add phases/discovery/research/002-auth.md --phase discovery --approved
stderr '✓ Added artifact to discovery phase'
stderr 'approved'

# Verify artifacts in state
exec cat .sow/project/state.yaml
stdout 'artifacts:'
stdout '001-jwt.md'
stdout '002-auth.md'

# =====================================
# Approve First Artifact
# =====================================
exec sow project artifact approve phases/discovery/research/001-jwt.md --phase discovery
stderr '✓ Approved artifact'

# Verify both artifacts now approved
exec cat .sow/project/state.yaml
stdout 'approved: true'

# =====================================
# Complete Discovery Phase
# =====================================
exec sow project phase complete discovery
stderr 'discovery'

# Verify state validates
exec sow validate
stderr '✓ All validations passed'

# =====================================
# Skip Design and Continue
# =====================================
exec sow project phase skip design
stderr '✓ Skipped design phase'

# Add task
exec sow task add 'Implement auth' --description 'Add JWT authentication'
stderr '✓ Created task 010'

# Complete task
exec sow task update 010 --status in_progress
exec sow task update 010 --status completed

# Review pass
exec sow project review add-report reports/001-review.md --assessment pass
stderr '✓ Added review report 001'

# Finalize
exec sow project finalize complete documentation
exec sow project finalize complete checks

# Delete project
exec sow project delete --force

# =====================================
# Final Verification
# =====================================
! exists .sow/project
exec sow validate
stderr '✓ All validations passed'
