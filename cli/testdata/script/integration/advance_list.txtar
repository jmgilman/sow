# Test: sow advance --list (Discovery Mode)
# Coverage: List all transitions, show blocked vs permitted, read-only behavior

# =====================================
# Setup Git Repository
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/test-list
exec sow init

env SOW_SKIP_UNCOMMITTED_CHECK=1

# =====================================
# Create Standard Project in ImplementationPlanning
# =====================================
exec mkdir -p .sow/project/phases/planning
exec mkdir -p .sow/project/phases/implementation
exec mkdir -p .sow/project/phases/review
exec mkdir -p .sow/project/phases/finalize

cp testdata/state.yaml .sow/project/state.yaml

-- testdata/state.yaml --
name: List mode test
type: standard
branch: feat/test-list
description: Test list mode
created_at: 2025-01-01T00:00:00Z
updated_at: 2025-01-01T00:00:00Z
phases:
  planning:
    status: completed
    enabled: true
    created_at: 2025-01-01T00:00:00Z
    started_at: 2025-01-01T00:00:00Z
    completed_at: 2025-01-01T00:01:00Z
    metadata: {}
    inputs: []
    outputs: []
    tasks: []
  implementation:
    status: in_progress
    enabled: true
    created_at: 2025-01-01T00:00:00Z
    started_at: 2025-01-01T00:01:00Z
    completed_at: 0001-01-01T00:00:00Z
    metadata:
      planning_approved: true
    inputs: []
    outputs: []
    tasks: []
  review:
    status: pending
    enabled: false
    created_at: 2025-01-01T00:00:00Z
    started_at: 0001-01-01T00:00:00Z
    completed_at: 0001-01-01T00:00:00Z
    metadata: {}
    inputs: []
    outputs: []
    tasks: []
  finalize:
    status: pending
    enabled: false
    created_at: 2025-01-01T00:00:00Z
    started_at: 0001-01-01T00:00:00Z
    completed_at: 0001-01-01T00:00:00Z
    metadata: {}
    inputs: []
    outputs: []
    tasks: []
statechart:
  current_state: ImplementationPlanning
  updated_at: 2025-01-01T00:00:00Z

# =====================================
# Test: List Mode Shows Permitted Transition
# =====================================

# Execute list mode (guard passes because planning_approved = true)
exec sow advance --list
stdout 'Current state: ImplementationPlanning'
stdout 'Available transitions'
stdout 'sow advance planning_complete'
stdout 'ImplementationDraftPRCreation'

# Verify descriptions shown
stdout 'Task descriptions approved'

# Verify NO [BLOCKED] marker (guard passes)
! stdout '\[BLOCKED\]'

# =====================================
# Test: List Mode is Read-Only (No Side Effects)
# =====================================

# Verify state unchanged after list
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# =====================================
# Test: List Mode Shows Blocked Transition
# =====================================

# Remove guard condition to block transition
exec sow phase set metadata.planning_approved false --phase implementation

# List should still show transition but with [BLOCKED] marker
exec sow advance --list
stdout 'Current state: ImplementationPlanning'
stdout 'sow advance planning_complete'
stdout '\[BLOCKED\]'

# State still unchanged
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# =====================================
# Test: List Mode Shows Terminal State
# =====================================

# Create project in terminal state (NoProject)
exec sow phase set metadata.planning_approved true --phase implementation
exec sow advance
exec sow phase set metadata.draft_pr_created true --phase implementation
exec sow advance

# Add completed tasks to advance to ReviewActive
exec mkdir -p .sow/project/phases/implementation/tasks/010
exec sh -c 'echo "# Task 010" > .sow/project/phases/implementation/tasks/010/description.md'
exec sow task add 'Test task' --agent implementer
exec sow task set --id 010 status completed

exec sow advance

# Add review artifact with pass assessment
exec mkdir -p .sow/project/phases/review
exec sh -c 'echo "# Review" > .sow/project/phases/review/report.md'
exec sow output add --type review --path review/report.md --phase review
exec sow output set --index 0 metadata.assessment pass --phase review
exec sow output set --index 0 approved true --phase review

# Advance through finalize to NoProject
exec sow advance
exec sow advance
exec mkdir -p .sow/project/phases/finalize
exec sh -c 'echo "# PR Body" > .sow/project/phases/finalize/pr_body.md'
exec sow output add --type pr_body --path finalize/pr_body.md --phase finalize
exec sow output set --index 0 approved true --phase finalize
exec sow advance
exec sow phase set metadata.pr_checks_passed true --phase finalize
exec sow advance
exec sow phase set metadata.project_deleted true --phase finalize
exec sow advance

# Verify we're in terminal state
exec cat .sow/project/state.yaml
stdout 'current_state: NoProject'

# List should indicate no transitions available
exec sow advance --list
stdout 'No transitions available'
stdout 'terminal state'
