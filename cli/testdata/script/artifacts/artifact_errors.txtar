# Test: Artifact Errors
# Coverage: index out of range, invalid artifact types, missing flags

exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec sh -c 'echo ".sow/worktrees/" > .gitignore'
exec git add .gitignore
exec git commit -m 'Initial commit'
exec git checkout -b feat/test
exec sow init
exec git add .sow
exec git commit -m 'Initialize sow'

env SOW_SKIP_UNCOMMITTED_CHECK=1

exec sow project new --branch feat/test --no-launch test-errors

# Change into worktree
cd .sow/worktrees/feat/test

# Test: Index out of range on empty list
! exec sow input set --index 0 approved true --phase planning
stderr 'index out of range'

! exec sow input remove --index 0 --phase planning
stderr 'index out of range'

# Add one input for further tests
exec mkdir -p .sow/project/context
exec sh -c 'echo "Test" > .sow/project/context/test.md'
exec sow input add --type context --path context/test.md --phase planning

# Test: Index out of range (valid: 0, invalid: 1)
! exec sow input set --index 1 approved true --phase planning
stderr 'index out of range'

! exec sow input remove --index 1 --phase planning
stderr 'index out of range'

# Test: Negative index
! exec sow input set --index -1 approved true --phase planning
stderr 'index out of range'

# Test: Missing required flags
! exec sow input add --path test.md --phase planning
stderr 'required flag.*type'

! exec sow input add --type context --phase planning
stderr 'required flag.*path'

! exec sow output add --path test.md --phase planning
stderr 'required flag.*type'

! exec sow output add --type task_list --phase planning
stderr 'required flag.*path'

# Test: Set requires index
! exec sow input set approved true --phase planning
stderr 'required flag.*index'

# Test: Remove requires index
! exec sow input remove --phase planning
stderr 'required flag.*index'

# Test: Invalid phase name
! exec sow input add --type context --path test.md --phase nonexistent
stderr 'phase not found'

! exec sow output list --phase nonexistent
stderr 'phase not found'
