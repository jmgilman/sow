# Test: Output Operations
# Coverage: add, set, remove, list for phase outputs

exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec sh -c 'echo ".sow/worktrees/" > .gitignore'
exec git add .gitignore
exec git commit -m 'Initial commit'
exec git checkout -b feat/test
exec sow init
exec git add .sow
exec git commit -m 'Initialize sow'

env SOW_SKIP_UNCOMMITTED_CHECK=1

exec sow project new --branch feat/test --no-launch test-outputs

# Change into worktree
cd .sow/worktrees/feat/test

# Create test file
exec mkdir -p .sow/project/planning
exec sh -c 'echo "Task list" > .sow/project/planning/tasks.md'

# Test: Add output artifact
exec sow output add --type task_list --path planning/tasks.md --phase planning
exec cat .sow/project/state.yaml
stdout 'type: task_list'
stdout 'path: planning/tasks.md'
stdout 'approved: false'

# Test: List outputs (shows index and details)
exec sow output list --phase planning
stdout '\[0\]'
stdout 'Type: task_list'
stdout 'Path: planning/tasks.md'
stdout 'Approved: false'

# Test: Set approved field using index
exec sow output set --index 0 approved true --phase planning
exec cat .sow/project/state.yaml
stdout 'approved: true'

# Test: Set metadata field using field path
exec sow output set --index 0 metadata.format markdown --phase planning
exec cat .sow/project/state.yaml
stdout 'format: markdown'

# Test: List shows updated values
exec sow output list --phase planning
stdout 'Approved: true'
stdout 'format: markdown'

# Test: Add second output
exec sh -c 'echo "Design doc" > .sow/project/planning/design.md'
exec sow output add --type task_list --path planning/design.md --phase planning
exec sow output list --phase planning
stdout '\[0\]'
stdout '\[1\]'
stdout 'tasks.md'
stdout 'design.md'

# Test: Remove output by index (remove first one)
exec sow output remove --index 0 --phase planning
exec sow output list --phase planning
stdout '\[0\]'
! stdout '\[1\]'
stdout 'design.md'
! stdout 'tasks.md'
