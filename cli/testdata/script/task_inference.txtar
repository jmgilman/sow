# Test task ID inference for commands
# Task ID should be inferred from current directory or active task status

exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/test-feature
exec sow init
exec sow project init my-feature --description 'Test inference'

# Transition to implementation phase
exec sow project phase enable discovery --type feature
exec sow project phase complete discovery
exec sow project phase enable design
exec sow project phase complete design

# Add three tasks
exec sow task add 'First task' --description 'Task 010' --agent implementer
exec sow task add 'Second task' --description 'Task 020' --agent implementer
exec sow task add 'Third task' --description 'Task 030' --agent implementer

# Test 1: Inference fails when no task is in_progress and not in task directory
! exec sow task status
stderr 'failed to infer task ID'
stderr 'no task currently in progress'

# Test 2: Set one task to in_progress - should infer from active task
exec sow task update 010 --status in_progress

exec sow task status
stderr 'Task: 010 - First task'
stderr 'Status: in_progress'

# Test 3: Inference from task directory takes precedence
cd .sow/project/phases/implementation/tasks/020

exec sow task status
stderr 'Task: 020 - Second task'
stderr 'Status: pending'

# Test 4: Can still provide explicit ID to override inference
exec sow task status 030
stderr 'Task: 030 - Third task'
stderr 'Status: pending'

cd $WORK

# Test 5: Multiple tasks in_progress - inference should fail
exec sow task update 020 --status in_progress

! exec sow task status
stderr 'failed to infer task ID'
stderr 'multiple tasks in progress'
stderr '010, 020'

# Test 6: Update command with inference
exec sow task update 010 --status completed

cd .sow/project/phases/implementation/tasks/020
exec sow task update --status completed
cd $WORK

exec sow task status 020
stderr 'Status: completed'

# Test 7: After completing both in_progress tasks, inference should fail again
! exec sow task status
stderr 'failed to infer task ID'
stderr 'no task currently in progress'
