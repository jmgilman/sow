# Test: E2E Initialization Errors
# Purpose: Test initialization error conditions and validation
# Exercises: Error handling for init, project init on wrong branch, duplicate project

# =====================================
# Error: Init without Git Repo
# =====================================
# Try to initialize without git
! exec sow init
stderr 'repository does not exist'

# =====================================
# Setup Git Repo
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'

# =====================================
# Successful Init
# =====================================
exec sow init
stderr '✓ sow initialized successfully'
exists .sow

# =====================================
# Error: Init Already Initialized
# =====================================
! exec sow init
stderr 'already initialized'

# =====================================
# Error: Project Init on Protected Branch
# =====================================
# git init creates master/main branch - we're currently on it
! exec sow project init test-project --description 'Should fail'
stderr 'protected branch'

# Switch to a feature branch temporarily
exec git checkout -b temp-branch

# Go back to master to verify it's also protected
exec git checkout master
! exec sow project init test-project --description 'Should fail'
stderr 'protected branch'

# =====================================
# Create Feature Branch
# =====================================
exec git checkout -b feat/test-feature

# =====================================
# Error: Project Init Without Description
# =====================================
! exec sow project init test-project
stderr 'required'

# =====================================
# Successful Project Init
# =====================================
exec sow project init test-project --description 'Test project'
stderr '✓ Initialized project'
exists .sow/project

# =====================================
# Error: Project Init When Project Exists
# =====================================
! exec sow project init another-project --description 'Should fail'
stderr 'already exists'

# =====================================
# Error: Invalid Project Name (Not Kebab-Case)
# =====================================
# Delete existing project first
exec sow project delete --force
! exists .sow/project

# Try with invalid name
! exec sow project init 'Bad_Name' --description 'Should fail'
stderr 'kebab-case'

! exec sow project init 'BadName' --description 'Should fail'
stderr 'kebab-case'

! exec sow project init 'bad name' --description 'Should fail'
stderr 'kebab-case'

# Valid kebab-case should work
exec sow project init good-name --description 'Valid name'
stderr '✓ Initialized project'

# =====================================
# Final Validation
# =====================================
exec sow validate
stderr '✓ All validations passed'
