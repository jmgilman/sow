# SKIP: Test uses removed 'sow project new' command
# TODO: Update test to use new interactive wizard or SDK directly
# Related PR: #83 - Wizard Foundation and State Machine

skip 'Test requires update for wizard interface - sow project new command removed'

# Test: Phase Set Operations
# Purpose: Test phase field mutations via unified CLI
# Coverage: set direct fields, set metadata fields, default to active phase

# =====================================
# Setup
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/test
exec sow init
exec git add .sow
exec git commit -m 'Initialize sow'
env SOW_SKIP_UNCOMMITTED_CHECK=1
exec sow project new --branch feat/test --no-launch 'Test phase commands'

# Change into worktree for remaining commands
cd .sow/worktrees/feat/test

# Verify project was created (initial state is ImplementationPlanning)
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# =====================================
# Test: Set Direct Field - Status
# =====================================

# Set phase status with explicit phase flag
exec sow phase set status in_progress --phase implementation
exec cat .sow/project/state.yaml
stdout 'status: in_progress'

# =====================================
# Test: Set Direct Field - Enabled
# =====================================

# Set phase enabled (direct field)
exec sow phase set enabled false --phase implementation
exec cat .sow/project/state.yaml
stdout 'enabled: false'

# =====================================
# Test: Set Metadata Field
# =====================================

# Set phase metadata with explicit phase
exec sow phase set metadata.custom_metadata true --phase implementation
exec cat .sow/project/state.yaml
stdout 'custom_metadata: "?true"?'

# =====================================
# Test: Default to Active Phase
# =====================================

# Set metadata without --phase flag (should default to implementation)
exec sow phase set metadata.custom_field test_value
exec cat .sow/project/state.yaml
stdout 'custom_field: test_value'

# Verify it was set on implementation phase (the active phase)
# The implementation phase should now have both enabled=false and custom_field
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*enabled: false.*custom_field: test_value'

# =====================================
# Test: Set Nested Metadata
# =====================================

# Set nested metadata field
exec sow phase set metadata.complexity.level high --phase implementation
exec cat .sow/project/state.yaml
stdout 'level: high'

# =====================================
# Test: Set Failed Status
# =====================================

# Set phase status to failed
exec sow phase set status failed --phase implementation
exec cat .sow/project/state.yaml
stdout 'status: failed'

# Verify failed status persists
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: failed'

# =====================================
# Test: Set Iteration Field
# =====================================

# Set iteration field (simulating rework cycle)
exec sow phase set iteration 2 --phase implementation
exec cat .sow/project/state.yaml
stdout 'iteration: 2'

# Set iteration to higher value
exec sow phase set iteration 3 --phase implementation
exec cat .sow/project/state.yaml
stdout 'iteration: 3'

# =====================================
# Test: Status Transitions
# =====================================

# Test valid status transitions
exec sow phase set status pending --phase implementation
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: pending'

exec sow phase set status in_progress --phase implementation
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: in_progress'

exec sow phase set status completed --phase implementation
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: completed'

exec sow phase set status failed --phase implementation
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: failed'

exec sow phase set status skipped --phase implementation
exec cat .sow/project/state.yaml
stdout '(?s)implementation:.*status: skipped'
