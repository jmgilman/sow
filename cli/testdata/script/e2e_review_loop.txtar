# Test: E2E Review Loop
# Purpose: Review failure and loopback to implementation
# Exercises: Review fail, review increment, add tasks after initial completion

# =====================================
# Setup
# =====================================
exec git init
exec git config user.email 'test@example.com'
exec git config user.name 'Test User'
exec git commit --allow-empty -m 'Initial commit'
exec git checkout -b feat/review-loop
exec sow init

# =====================================
# Project Initialization
# =====================================
exec sow agent project init review-loop-project --description 'Test review failure and loop'
stderr '✓ Initialized project'

# Skip optional phases
exec sow agent project phase skip discovery
exec sow agent project phase skip design

# =====================================
# Initial Implementation
# =====================================
# Add initial tasks
exec sow agent task add 'Implement feature' --description 'Core functionality'
stderr '✓ Created task 010'

exec sow agent task add 'Add tests' --description 'Unit tests'
stderr '✓ Created task 020'

# Approve task plan
exec sow agent project phase approve implementation
stderr '✓ Approved implementation phase plan'

# Complete both tasks
exec sow agent task update 010 --status in_progress
exec sow agent task update 010 --status completed
exec sow agent task update 020 --status in_progress
exec sow agent task update 020 --status completed

# =====================================
# First Review - FAIL
# =====================================
exec sow agent project review add-report reports/001-review.md --assessment fail
stderr '✓ Added review report 001'

# Approve review (triggers loop back to implementation)
exec sow agent project review approve 001
stderr '✓ Approved review report 001'

# Verify we're back in ImplementationPlanning
exec cat .sow/project/state.yaml
stdout 'current_state: ImplementationPlanning'

# Verify state validates after loop back
exec sow validate
stderr '✓ All validations passed'

# =====================================
# Additional Task After Review Failure
# =====================================
# Add task to fix issues found in review
exec sow agent task add 'Fix review issues' --description 'Address feedback from review'
stderr '✓ Created task 030'

# Approve task plan again
exec sow agent project phase approve implementation
stderr '✓ Approved implementation phase plan'

# Complete the fix task
exec sow agent task update 030 --status in_progress
exec sow agent task update 030 --status completed

# =====================================
# Second Review - PASS
# =====================================
exec sow agent project review add-report reports/002-review.md --assessment pass
stderr '✓ Added review report 002'

# Approve review (triggers transition to finalize)
exec sow agent project review approve 002
stderr '✓ Approved review report 002'

# Verify two reports exist
exec cat .sow/project/state.yaml
stdout '001'
stdout '002'
stdout 'assessment: pass'

# =====================================
# Finalize and Complete
# =====================================
exec sow agent project finalize complete documentation
exec sow agent project finalize complete checks
exec sow agent project delete --force

# =====================================
# Final Verification
# =====================================
! exists .sow/project
exec sow validate
stderr '✓ All validations passed'
