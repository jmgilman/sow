# Test git ref with local repository

# Set HOME to test workspace so cache can be created
env HOME=$WORK

exec git init
exec git config user.email 'test@test.com'
exec git config user.name 'Test'
exec sow init

# Create a local git repo to use as source
mkdir source-repo
cd source-repo
exec git init
exec git config user.email 'test@test.com'
exec git config user.name 'Test'
exec sh -c 'echo "source content" > README.md'
exec git add .
exec git commit -m 'Initial commit'
cd ..

# Add git ref using git+file:// URL pointing to the source repo
exec sow refs add git+file://$WORK/source-repo --id=local-repo --link=local-repo --semantic=code --description='Local repo'
stderr '✓ Added git ref:'

# Verify workspace symlink was created
exists .sow/refs/local-repo

# Verify cloned content exists and is accessible
exists .sow/refs/local-repo/README.md
exec cat .sow/refs/local-repo/README.md
stdout 'source content'

# List refs with type filter
exec sow refs list --type=git
stdout 'local-repo'
stdout 'code'

# Update the ref
exec sow refs update local-repo
stderr '✓ Updated local-repo'

# Remove the ref with force flag
exec sow refs remove local-repo --force
stderr '✓ Removed'

# Verify cleanup
! exists .sow/refs/local-repo
